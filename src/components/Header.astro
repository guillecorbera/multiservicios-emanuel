---
// src/components/Header.astro
import { getTranslation, supportedLangs, type Lang } from '../utils/i18n';

// Prop para recibir el idioma actual de la página padre (index.astro)
interface Props {
    currentLang?: Lang; 
}

const { currentLang = 'es' } = Astro.props; 

// Función de traducción
const t = (key: string) => getTranslation(currentLang, key);

// Definición de enlaces de navegación, sin hash para evitar scroll automático
const navItems = [
  { key: 'nav_home', section: 'inicio', isExternal: false },
  { key: 'nav_works', section: 'trabajos', isExternal: false },
  { key: 'nav_services', section: 'servicios', isExternal: false },
  { key: 'nav_tips', section: 'consejos', isExternal: false },
  { key: 'nav_contact', section: 'contacto', isExternal: false },
];

// Script para manejar el cambio de idioma será implementado directamente en el script tag
---

<header class="bg-white shadow-md p-4 sticky top-0 z-50">
  <div class="container mx-auto flex flex-wrap justify-between items-center">
    
    <a href="/" class="text-3xl font-extrabold text-blue-700 hover:text-blue-900 transition mb-2 md:mb-0">
      Multiservicios Emanuel
    </a>

    <nav class="hidden md:flex grow justify-center space-x-6">
      {navItems.map((item) => (
        <button 
          data-section={item.section}
          class="nav-link text-gray-600 hover:text-blue-700 font-medium py-2 px-3 rounded-md transition duration-300 ease-in-out cursor-pointer bg-transparent border-none"
        >
          {t(item.key)}
        </button>
      ))}
    </nav>

    <div class="language-links flex items-center space-x-1 ml-auto md:ml-0" aria-label="Selector de Idioma">
        <a 
            href="#" 
            data-lang="es"
            class={`language-link px-2 py-1 font-medium text-sm transition-colors duration-300 hover:text-blue-600 flex items-center justify-center min-h-[28px] ${currentLang === 'es' ? 'active text-blue-600 font-bold' : 'text-gray-600'}`}
            aria-current={currentLang === 'es' ? 'true' : undefined}
        >
            ESP
        </a>
        <span class="separator text-gray-400 select-none">|</span>
        <a 
            href="#" 
            data-lang="ca"
            class={`language-link px-2 py-1 font-medium text-sm transition-colors duration-300 hover:text-blue-600 flex items-center justify-center min-h-[28px] ${currentLang === 'ca' ? 'active text-blue-600 font-bold' : 'text-gray-600'}`}
            aria-current={currentLang === 'ca' ? 'true' : undefined}
        >
            CAT
        </a>
        <span class="separator text-gray-400 select-none">|</span>
        <a 
            href="#" 
            data-lang="en"
            class={`language-link px-2 py-1 font-medium text-sm transition-colors duration-300 hover:text-blue-600 flex items-center justify-center min-h-[28px] ${currentLang === 'en' ? 'active text-blue-600 font-bold' : 'text-gray-600'}`}
            aria-current={currentLang === 'en' ? 'true' : undefined}
        >
            ENG
        </a>
    </div>

    <button class="md:hidden p-2 rounded-md text-gray-600 hover:bg-gray-100 ml-4">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M4 6h16M4 12h16M4 18h16" />
        </svg>
    </button>

  </div>
</header>

<script is:inline>
  // Script para mejorar la navegación
  document.addEventListener('DOMContentLoaded', function() {
    // Detectar y aplicar idioma guardado al cargar la página
    try {
      const storedLang = localStorage.getItem('selectedLanguage') || sessionStorage.getItem('selectedLanguage');
      if (storedLang && ['es', 'ca', 'en'].includes(storedLang) && storedLang !== 'es') {
        console.log('Aplicando idioma guardado:', storedLang);
        changeLanguageDynamically(storedLang);
      }
    } catch (error) {
      console.log('No se pudo detectar idioma previo, usando español por defecto');
    }
    
    // Manejar sección guardada desde cambio de idioma (SIN hash)
    const targetSection = sessionStorage.getItem('targetSection');
    if (targetSection) {
        sessionStorage.removeItem('targetSection');
        const targetElement = document.getElementById(targetSection);
        if (targetElement) {
            const headerHeight = 80;
            const elementTop = targetElement.offsetTop - headerHeight;
            
            console.log('Navegando a sección guardada:', targetSection);
            
            // Scroll instantáneo sin animación
            window.scrollTo(0, elementTop);
        }
    }
    // Si hay hash en URL al cargar página (navegación directa)
    else if (window.location.hash) {
        const hashId = window.location.hash.substring(1);
        const targetElement = document.getElementById(hashId);
        if (targetElement) {
            const headerHeight = 80;
            const elementTop = targetElement.offsetTop - headerHeight;
            
            // Scroll normal para navegación directa
            requestAnimationFrame(() => {
                window.scrollTo(0, elementTop);
                document.documentElement.scrollTop = elementTop;
                document.body.scrollTop = elementTop;
            });
        }
    }
    // Manejar navegación por secciones sin hash
    const navButtons = document.querySelectorAll('.nav-link');
    navButtons.forEach(function(button) {
        button.addEventListener('click', function(e) {
            const targetSection = button.getAttribute('data-section');
            
            e.preventDefault();
            console.log('Navegando a sección:', targetSection, 'desde:', window.location.pathname);
            
            if (targetSection) {
                // Si estamos en la página de consejos
                if (window.location.pathname === '/consejos') {
                    if (targetSection === 'consejos') {
                        // Si ya estamos en consejos, hacer scroll al top
                        window.scrollTo({ top: 0, behavior: 'smooth' });
                        return;
                    } else {
                        // Si queremos ir a otra sección, ir a la página principal
                        console.log('Redirigiendo desde consejos a:', targetSection);
                        window.location.href = `/#${targetSection}`;
                        return;
                    }
                }
                
                // Si estamos en la página principal, buscar el elemento
                const targetElement = document.getElementById(targetSection);
                if (targetElement) {
                    console.log('Elemento encontrado:', targetSection);
                    
                    // Actualizar indicador inmediatamente
                    navButtons.forEach(function(btn) { 
                        btn.classList.remove('active'); 
                    });
                    button.classList.add('active');
                    
                    // Scroll suave con offset para compensar el header
                    const headerHeight = 80;
                    const targetPosition = targetElement.offsetTop - headerHeight;
                    
                    window.scrollTo({
                        top: targetPosition,
                        behavior: 'smooth'
                    });
                } else {
                    console.log('Elemento no encontrado:', targetSection);
                    // Si no se encuentra el elemento, ir a la página principal
                    if (window.location.pathname !== '/') {
                        console.log('Redirigiendo a página principal:', targetSection);
                        window.location.href = `/#${targetSection}`;
                    }
                }
            }
        });
    });

    // Manejar cambio de idioma preservando la sección actual
    const languageLinks = document.querySelectorAll('.language-link');
    languageLinks.forEach(function(link) {
        // Marcar como manejado por el Header
        link.setAttribute('data-header-handled', 'true');
        
        // Efectos hover
        link.addEventListener('mouseenter', function() {
            if (!link.classList.contains('active')) {
                link.style.transform = 'scale(1.1)';
            }
        });
        
        link.addEventListener('mouseleave', function() {
            link.style.transform = 'scale(1)';
        });

        // Manejar click para cambio de idioma SIN recargar página
        link.addEventListener('click', function(e) {
            e.preventDefault();
            
            const newLang = link.getAttribute('data-lang');
            const currentActive = link.classList.contains('active');
            
            console.log('Header: Click en idioma:', newLang, 'Actualmente activo:', currentActive);
            
            // Solo cambiar si no es el idioma actual
            if (newLang && !currentActive) {
                console.log('Header: Iniciando cambio de idioma a:', newLang);
                
                // Cambiar idioma dinámicamente sin recarga
                changeLanguageDynamically(newLang);
            } else {
                console.log('Header: No se cambia idioma - ya está activo o newLang es null');
            }
        });
    });

    // Función para detectar la sección actual basada en la posición del scroll
    function getCurrentSection() {
        const sections = ['inicio', 'trabajos', 'servicios', 'consejos', 'contacto'];
        const headerHeight = 80;
        const scrollPosition = window.scrollY + headerHeight + 100; // Offset adicional
        
        let currentSection = 'inicio'; // Por defecto
        
        for (const sectionId of sections) {
            const section = document.getElementById(sectionId);
            if (section) {
                const sectionTop = section.offsetTop;
                const sectionBottom = sectionTop + section.offsetHeight;
                
                if (scrollPosition >= sectionTop && scrollPosition < sectionBottom) {
                    currentSection = sectionId;
                    break;
                }
            } else {
                console.log('Sección no encontrada:', sectionId);
            }
        }
        
        console.log('Sección actual detectada:', currentSection);
        return currentSection;
    }

    // Función para actualizar el indicador de sección activa
    function updateActiveNavIndicator() {
        const currentSection = getCurrentSection();
        const navButtons = document.querySelectorAll('.nav-link');
        const sections = ['inicio', 'trabajos', 'servicios', 'consejos', 'contacto'];
        
        navButtons.forEach((button, index) => {
            const sectionName = sections[index];
            if (sectionName === currentSection) {
                button.classList.add('active');
            } else {
                button.classList.remove('active');
            }
        });
    }

    // Actualizar indicador al hacer scroll
    let scrollTimeout;
    window.addEventListener('scroll', function() {
        clearTimeout(scrollTimeout);
        scrollTimeout = setTimeout(function() {
            updateActiveNavIndicator();
        }, 50); // Throttle para mejor performance
    });

    // Actualizar indicador al cargar la página
    updateActiveNavIndicator();

    // Función para cambiar idioma dinámicamente sin recargar página
    async function changeLanguageDynamically(newLang) {
        try {
            console.log('Cargando traducciones para:', newLang);
            
            // Guardar idioma seleccionado
            try {
                localStorage.setItem('selectedLanguage', newLang);
                sessionStorage.setItem('selectedLanguage', newLang);
            } catch (error) {
                console.log('No se pudo guardar el idioma seleccionado');
            }
            
            // Cargar las traducciones del nuevo idioma
            const response = await fetch('/translations.json');
            const translations = await response.json();
            
            if (translations[newLang]) {
                // PRIMERO: Actualizar enlaces activos del selector
                updateActiveLanguage(newLang);
                
                // SEGUNDO: Actualizar todos los textos de la página
                updatePageTexts(translations[newLang]);
                
                // TERCERO: Actualizar URL sin recarga (solo para el historial)
                window.history.pushState(null, '', '/');
                
                console.log('Idioma cambiado exitosamente a:', newLang);
            }
        } catch (error) {
            console.error('Error cambiando idioma:', error);
        }
    }

    // Función para actualizar todos los textos de la página
    function updatePageTexts(translations) {
        // Actualizar navegación
        const navButtons = document.querySelectorAll('.nav-link');
        navButtons.forEach(function(button, index) {
            const keys = ['nav_home', 'nav_works', 'nav_services', 'nav_tips', 'nav_contact'];
            if (keys[index]) {
                button.textContent = translations[keys[index]] || button.textContent;
            }
        });

        // Actualizar otros elementos con data-key
        document.querySelectorAll('[data-translate]').forEach(function(element) {
            const key = element.getAttribute('data-translate');
            if (key && translations[key]) {
                element.textContent = translations[key];
            }
        });
        
        // Actualizar componente de Consejos si está presente
        try {
            const currentLang = localStorage.getItem('selectedLanguage') || 'es';
            Object.keys(window).forEach(function(key) {
                if (key.startsWith('updateConsejos_') && typeof window[key] === 'function') {
                    console.log('Header: Actualizando componente Consejos:', key, 'a idioma:', currentLang);
                    window[key](currentLang);
                }
            });
        } catch (error) {
            console.log('Header: Error actualizando componentes Consejos:', error);
        }
    }

    // Función para actualizar el idioma activo en el selector
    function updateActiveLanguage(newLang) {
        console.log('Header: Actualizando selector de idioma a:', newLang);
        document.querySelectorAll('.language-link').forEach(function(link) {
            const lang = link.getAttribute('data-lang');
            if (lang === newLang) {
                console.log('Header: Activando enlace para idioma:', lang);
                link.classList.add('active', 'text-blue-600', 'font-bold');
                link.classList.remove('text-gray-600');
                link.setAttribute('aria-current', 'true');
            } else {
                console.log('Header: Desactivando enlace para idioma:', lang);
                link.classList.remove('active', 'text-blue-600', 'font-bold');
                link.classList.add('text-gray-600');
                link.removeAttribute('aria-current');
            }
        });
        console.log('Header: Actualización de selector completada');
    }
  });
</script>

<style>
    /* Estilos adicionales para los enlaces de idioma */
    .language-links {
        font-family: 'Roboto', sans-serif;
    }
    
    .language-link {
        position: relative;
        transition: all 0.3s ease;
        border-radius: 4px;
    }
    
    .language-link:hover:not(.active) {
        background-color: rgba(59, 130, 246, 0.1);
    }
    
    .language-link.active {
        background-color: rgba(59, 130, 246, 0.15);
    }
    
    .separator {
        font-weight: 300;
        user-select: none;
    }
    
    /* Estilos para indicador de sección activa en navegación */
    .nav-link {
        position: relative;
        transition: all 0.3s ease;
    }
    
    .nav-link.active {
        color: rgb(29, 78, 216); /* text-blue-700 */
        font-weight: 600;
    }
    
    .nav-link.active::after {
        content: '';
        position: absolute;
        bottom: -8px;
        left: 50%;
        transform: translateX(-50%);
        width: 80%;
        height: 3px;
        background: linear-gradient(90deg, rgb(59, 130, 246), rgb(29, 78, 216));
        border-radius: 2px;
        animation: slideIn 0.3s ease-out;
    }
    
    @keyframes slideIn {
        from {
            width: 0%;
            opacity: 0;
        }
        to {
            width: 80%;
            opacity: 1;
        }
    }
    
    @media (max-width: 768px) {
        .language-links {
            font-size: 0.875rem;
        }
        
        .language-link {
            padding: 0.25rem 0.5rem;
        }
        
        .nav-link.active::after {
            bottom: -4px;
        }
    }
</style>